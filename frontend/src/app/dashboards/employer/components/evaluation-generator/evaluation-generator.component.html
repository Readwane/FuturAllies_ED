<div class="quiz-generator-container">
  <mat-tab-group (selectedIndexChange)="onTabChange($event)">
    <!-- Onglet Quiz -->
    <mat-tab label="Quiz de présélection">
      <form [formGroup]="quizForm" class="generator-form">
        <mat-form-field appearance="outline">
          <mat-label>Poste concerné</mat-label>
          <input matInput formControlName="profil" readonly>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Thème technique</mat-label>
          <input matInput formControlName="quizTopic" readonly>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Prompt de génération</mat-label>
          <textarea matInput formControlName="quizPrompt" rows="3" required></textarea>
          <button mat-icon-button matSuffix (click)="regeneratePrompt('quiz')">
            <mat-icon>autorenew</mat-icon>
          </button>
        </mat-form-field>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Questions à choix multiple</mat-label>
            <input matInput type="number" formControlName="questionQcmCount">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Questions à choix unique</mat-label>
            <input matInput type="number" formControlName="questionQcuCount">
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Total de questions</mat-label>
            <input matInput type="number" formControlName="questionTotalCount" readonly>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Durée (minutes)</mat-label>
            <input matInput type="number" formControlName="quizDuration">
          </mat-form-field>
        </div>

       <div class="form-row">
        <mat-form-field appearance="outline">
            <mat-label>Difficulté</mat-label>
            <mat-select formControlName="difficulty">
              <mat-option value="easy">Débutant</mat-option>
              <mat-option value="medium">Intermédiaire</mat-option>
              <mat-option value="hard">Avancé</mat-option>
            </mat-select>
          </mat-form-field>
  
          <mat-form-field appearance="outline">
            <mat-label>Points totaux</mat-label>
            <input matInput type="number" formControlName="totalPoints">
          </mat-form-field>
       </div>

        <button mat-raised-button color="primary" (click)="generateQuiz()" [disabled]="quizForm.invalid || isLoading">
          Générer le quiz
        </button>

        <div *ngIf="generatedQuiz" class="result-container">
          <h3>Quiz généré ({{ generatedQuiz.duration }} minutes)</h3>
          <p><strong>Thème :</strong> {{ generatedQuiz.topic }}</p>
          <p><strong>Difficulté :</strong> {{ generatedQuiz.difficulty }}</p>
          <p><strong>Nombre de questions :</strong> {{ generatedQuiz.totalQuestions }}</p>
          <p><strong>Points totaux :</strong> {{ generatedQuiz.totalPoints }}</p>

          <div *ngFor="let question of generatedQuestions">
            <h4>Question {{ question.order }} ({{ question.questionType }})</h4>
            <p>{{ question.title }}</p>
            <ul>
              <li *ngFor="let option of question.options">{{ option }}</li>
            </ul>
            <p><strong>Réponses correctes :</strong> {{ question.correctOptions.join(', ') }}</p>
            <!-- <p><strong>Points :</strong> {{ question.points }}</p> -->
          </div>
        </div>
      </form>
    </mat-tab>

    <!-- Onglet Évaluation -->
    <mat-tab label="Sujet d'évaluation technique">
      <form [formGroup]="evaluationForm" class="generator-form">
        <mat-form-field appearance="outline">
          <mat-label>Poste concerné</mat-label>
          <input matInput formControlName="profil" readonly>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Thème technique</mat-label>
          <input matInput formControlName="technicalTopic" readonly>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Prompt de génération</mat-label>
          <textarea matInput formControlName="evalPrompt" rows="3" required></textarea>
          <button mat-icon-button matSuffix (click)="regeneratePrompt('evaluation')">
            <mat-icon>autorenew</mat-icon>
          </button>
        </mat-form-field>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Complexité</mat-label>
            <mat-select formControlName="difficulty">
              <mat-option value="junior">Junior</mat-option>
              <mat-option value="intermediate">Intermédiaire</mat-option>
              <mat-option value="senior">Senior</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Durée (minutes)</mat-label>
            <input matInput type="number" formControlName="evalDuration">
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Nombre de sections</mat-label>
            <input matInput type="number" formControlName="totalSections">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Points totaux</mat-label>
            <input matInput type="number" formControlName="totalPoints">
          </mat-form-field>
        </div>

        <button mat-raised-button color="primary" (click)="generateEvaluation()" [disabled]="evaluationForm.invalid || isLoading">
          Générer le sujet
        </button>

        <div *ngIf="generatedEvaluation" class="result-container">
          <h3>Sujet généré ({{ generatedEvaluation.duration }} minutes)</h3>
          <p><strong>Thème :</strong> {{ generatedEvaluation.topic }}</p>
          <p><strong>Complexité :</strong> {{ generatedEvaluation.difficulty }}</p>
          <p><strong>Nombre de sections :</strong> {{ generatedEvaluation.totalSections }}</p>
          <p><strong>Points totaux :</strong> {{ generatedEvaluation.totalPoints }}</p>

          <mat-accordion>
            <mat-expansion-panel *ngFor="let section of generatedSections">
              <mat-expansion-panel-header>
                {{ section.title }}
              </mat-expansion-panel-header>
              <div *ngFor="let contentId of section.EvaluationId">
                <div *ngIf="getContentById(contentId) as content">
                  <h4>{{ content.type | titlecase }}</h4>
                  <p>{{ content.content }}</p>
                </div>
              </div>
            </mat-expansion-panel>
          </mat-accordion>
        </div>
      </form>
    </mat-tab>
  </mat-tab-group>

  <div *ngIf="isLoading" class="loader-overlay">
    <mat-spinner diameter="50"></mat-spinner>
  </div>
</div>